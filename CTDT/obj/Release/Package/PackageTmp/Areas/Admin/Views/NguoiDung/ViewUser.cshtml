@{
    ViewBag.Title = "Danh sách tài khoản - TDMU";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="main-content">
    <div class="page-header">
        <h2 class="header-title">Quản Lý Danh Sách Tài Khoản</h2>
        <div class="header-sub-title">
            <nav class="breadcrumb breadcrumb-dash">
                <a href="#" class="breadcrumb-item"><i class="anticon anticon-home m-r-5"></i>Home</a>
                <span class="breadcrumb-item active">Danh sách Tài khoản</span>
            </nav>
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <h4>Quản Lý Danh Tài Khoản</h4>
            <div>
                <button class="btn btn-primary btn-tone m-r-5" data-toggle="modal" data-target="#bd-example-modal-lg">Thêm mới</button>
                <button class="btn btn-success btn-tone m-r-5" data-toggle="modal" data-target="#importExcelModal">Import từ Excel</button>
            </div>
            <div class="row justify-content-end m-b-20">
                <div class="col-auto">
                    <input type="text" id="searchInput" class="form-control" placeholder="Nhập từ khóa tìm kiếm...">
                </div>
            </div>
            <!-- Modal Thêm mới User -->
            <div class="modal fade" id="bd-example-modal-lg">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title h4">Thêm mới Người dùng</h5>
                            <button type="button" class="close" data-dismiss="modal">
                                <i class="anticon anticon-close"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="form-validation">
                                <div class="form-group row">
                                    <label class="col-sm-2 col-form-label control-label">Email</label>
                                    <div class="col-sm-10">
                                        <input type="email" class="form-control" id="Email" required>
                                    </div>

                                    <label class="col-sm-2 col-form-label control-label" style="margin-top: 10px;">Chức vụ *</label>
                                    <div class="col-sm-10" style="margin-top: 10px;">
                                        <select id="ChucVu" name="ChucVu" class="form-control" required>
                                            @foreach (var typeUser in ViewBag.TypeUserList)
                                            {
                                                <option value="@typeUser.Value">@typeUser.Text</option>
                                            }
                                        </select>
                                    </div>

                                    <div class="col-sm-10" id="ctdtContainer" style="margin-top: 10px; display: none;">
                                        <label class="col-sm-2 col-form-label control-label">CTĐT *</label>
                                        <select id="CTDT" name="CTDT" class="form-control" style="margin-left: 130px; margin-top: -34px;">
                                            @foreach (var ctdt in ViewBag.CTDTList)
                                            {
                                                <option value="@ctdt.Value">@ctdt.Text</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                            </form>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-danger btn-tone m-r-5" data-dismiss="modal">Thoát</button>
                                <button type="button" class="btn btn-success btn-tone m-r-5" id="btnSave">Lưu</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Modal Thêm mới User -->
            <!-- Modal Sửa User -->
            <div class="modal fade" id="ModalEditLop">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title h4">Sửa đổi Người dùng</h5>
                            <button type="button" class="close" data-dismiss="modal">
                                <i class="anticon anticon-close"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="form-validation">
                                <div class="form-group row">
                                    <input type="hidden" id="Edit_ID" />
                                    <input type="hidden" id="Edit_TenNguoiDung" />
                                    <input type="hidden" id="change_Ngay_Tao" name="change_Ngay_Tao" />
                                    <label class="col-sm-2 col-form-label control-label">Email</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="Edit_Email" readonly>
                                    </div>
                                    <label class="col-sm-2 col-form-label control-label" style="margin-top: 10px;">Chức vụ *</label>
                                    <div class="col-sm-10" style="margin-top: 10px;">
                                        <select id="Edit_ChucVu" name="Edit_ChucVu" class="form-control">
                                            @foreach (var typeUser in ViewBag.TypeUserList)
                                            {
                                                <option value="@typeUser.Value">@typeUser.Text</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-sm-10" id="ctdtContainer" style="margin-top: 10px; display: none;">
                                        <label class="col-sm-2 col-form-label control-label">CTĐT *</label>
                                        <select id="Edit_CTDT" name="Edit_CTDT" class="form-control" style=" margin-left: 130px; margin-top: -34px;">
                                            @foreach (var ctdt in ViewBag.CTDTList)
                                            {
                                                <option value="@ctdt.Value">@ctdt.Text</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                            </form>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-danger btn-tone m-r-5" data-dismiss="modal">Thoát</button>
                                <button type="button" class="btn btn-success btn-tone m-r-5" id="btnSaveChange">Thay đổi</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--End Modal Sửa User -->
            <div class="m-t-25">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th scope="col">STT</th>
                                <th scope="col">ID User</th>
                                <th scope="col">Tên người dùng</th>
                                <th scope="col">Email</th>
                                <th scope="col">Chức vụ</th>
                                <th scope="col">CTĐT</th>
                                <th scope="col">Ngày tạo</th>
                                <th scope="col">Ngày cập nhật</th>
                                <th scope="col">Chức năng</th>
                            </tr>
                        </thead>
                        <tbody id="showdata">
                        </tbody>
                    </table>
                </div>
                <div id="pagination" class="m-t-15 pagination-right">
                    <!-- Pagination buttons will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    var currentPage = 1;
    var totalPages = 0;

    $(document).ready(function () {
        LoadData(currentPage);
        $(document).on('keyup', "#searchInput", debounce(function () {
            var keyword = $(this).val().toLowerCase();
            LoadData(currentPage, keyword);
        }, 1000));
        $("#btnSave").click(function () {
            AddUser();
        });
        $('#ChucVu, #Edit_ChucVu').change(function () {
            toggleCTDTDropdown($(this).attr('id'));
        });

        $(document).on("click", "#btnSave", function () {
            AddLop();
        });

        $(document).on("click", ".page-link", function () {
            var page = $(this).data("page");
            if (page > 0 && page <= totalPages) {
                currentPage = page;
                LoadData(currentPage);
            }
        });

        $(document).on("click", ".btnEdit", function () {
            var MaUser = $(this).closest("tr").find("td:eq(1)").text().substring(1);
            GetByID(MaUser);
        });

        $(document).on("click", "#btnSaveChange", function () {
            EditUser();
        });

        $(document).on("click", ".btnDelete", function () {
            var id = $(this).closest("tr").find("td:eq(1)").text().substring(1);
            var name = $(this).closest("tr").find("td:eq(2)").text();

            Swal.fire({
                icon: 'warning',
                title: 'Bạn có chắc muốn xóa?',
                text: "Bạn đang cố gắng xóa tài khoản '" + name + "'",
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    DelNguoiDung(id);
                }
            });
        });
    });

    function toggleCTDTDropdown(chucVuId) {
        var selectedRole = $('#' + chucVuId).val();
        if (selectedRole == 3) {
            $('#' + chucVuId).closest('.form-group').find('#ctdtContainer').show();
        } else {
            $('#' + chucVuId).closest('.form-group').find('#ctdtContainer').hide();
        }
    }

    function search() {
        var keyword = $('#searchInput').val().toLowerCase();
        $('#showdata tr').filter(function () {
            $(this).toggle($(this).text().toLowerCase().indexOf(keyword) > -1)
        });
    }

    function AddUser() {
        var Email = $("#Email").val();
        var ChucVu = $('#ChucVu').val();
        var CTDT = ChucVu == '3' ? $('#CTDT').val() : null;

        $.ajax({
            url: '/Admin/NguoiDung/Add',
            type: 'POST',
            dataType: 'JSON',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({
                email: Email,
                id_typeusers: ChucVu,
                id_ctdt: CTDT
            }),
            success: function (response) {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: response.status,
                        showConfirmButton: false,
                        timer: 2000
                    });
                    LoadData(currentPage);
                    $('#bd-example-modal-lg').modal('hide');
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: response.status
                    });
                }
            },
            error: function (response) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Đã có lỗi xảy ra. Vui lòng thử lại sau.'
                });
            }
        });
    }

    function EditUser() {
        var id_users = $('#Edit_ID').val();
        var name = $('#Edit_TenNguoiDung').val();
        var email = $('#Edit_Email').val();
        var id_typeusers = $('#Edit_ChucVu').val();
        var id_ctdt = id_typeusers == 3 ? $('#Edit_CTDT').val() : null;
        var ngaytao = $('#change_Ngay_Tao').val();
        var users = {
            id_users: id_users,
            name: name,
            email: email,
            id_typeusers: id_typeusers,
            id_ctdt: id_ctdt,
            ngaytao: ngaytao
        };

        $.ajax({
            type: 'POST',
            url: '/Admin/NguoiDung/Edit',
            dataType: 'JSON',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(users),
            success: function (response) {
                Swal.fire({
                    icon: 'success',
                    title: response.status,
                    showConfirmButton: false,
                    timer: 2000
                });
                LoadData(currentPage);
            },
            error: function (response) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Cập nhật thông tin tài khoản thất bại'
                });
            },
        });
    }

    function DelNguoiDung(id) {
        $.ajax({
            type: 'POST',
            url: '/Admin/NguoiDung/Delete',
            data: JSON.stringify({ id: id }),
            contentType: 'application/json; charset=utf-8',
            success: function (response) {
                Swal.fire({
                    icon: 'success',
                    title: response.status,
                    showConfirmButton: false,
                    timer: 2000
                });
                LoadData(currentPage);
            },
            error: function (response) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Xóa tài khoản thất bại: ' + response.status,
                });
            }
        });
    }

    function GetByID(id) {
        $.ajax({
            url: '/Admin/NguoiDung/GetByID',
            type: 'GET',
            data: { id: id },
            success: function (res) {
                if (res.status !== "Load dữ liệu thành công") {
                    alert(res.status);
                    return;
                }
                $('#Edit_ID').val(res.data.id_users);
                $('#Edit_TenNguoiDung').val(res.data.name);
                $('#Edit_Email').val(res.data.email);
                $('#Edit_ChucVu').val(res.data.id_typeusers);
                if (res.data.id_typeusers == 3) {
                    $('#Edit_CTDT').val(res.data.id_ctdt);
                    $('#Edit_CTDT').closest('.form-group').find('#ctdtContainer').show();
                } else {
                    $('#Edit_CTDT').val(null);
                    $('#Edit_CTDT').closest('.form-group').find('#ctdtContainer').hide();
                }
                $('#change_Ngay_Tao').val(res.data.ngaytao);
            }
        });
    }

    function LoadData(pageNumber, keyword) {
        $.ajax({
            url: '/Admin/NguoiDung/LoadUser',
            type: 'GET',
            data: { pageNumber: pageNumber, pageSize: 10, keyword: keyword },
            success: function (res) {
                var items = res.data;
                totalPages = res.totalPages;
                var html = "";

                if (items.length === 0) {
                    html += "<tr><td colspan='9' class='text-center'>Không có dữ liệu</td></tr>";
                } else {
                    for (let i = 0; i < items.length; i++) {
                        var formattedDate1 = unixTimestampToDate(items[i].NgayCapNhat);
                        var formattedDate2 = unixTimestampToDate(items[i].NgayTao);
                        var index = (pageNumber - 1) * 10 + i + 1;
                        html += "<tr>";
                        html += "<td>" + index + "</td>";
                        html += "<td># " + items[i].MaUser + "</td>";
                        html += "<td>" + items[i].TenUser + "</td>";
                        html += "<td>" + items[i].EmailUser + "</td>";
                        html += "<td>" + items[i].ChucVu + "</td>";
                        html += "<td>" + (items[i].TypeCTDT || 'Không có CTĐT') + "</td>";
                        html += "<td>" + formattedDate2 + "</td>";
                        html += "<td>" + formattedDate1 + "</td>";
                        html += "<td><button class='btn btn-icon btn-hover btn-sm btn-rounded pull-right btnEdit' data-toggle='modal' data-target='#ModalEditLop'><i class='anticon anticon-edit'></i></button><button class='btn btn-icon btn-hover btn-sm btn-rounded pull-right btnDelete'><i class='anticon anticon-delete'></i></button></td>";
                        html += "</tr>";
                    }
                }
                $('#showdata').html(html);
                renderPagination(pageNumber, totalPages);
            },
            error: function () {
                var html = "<tr><td colspan='9' class='text-center'>Không thể tải dữ liệu</td></tr>";
                $('#showdata').html(html);
            }
        });
    }

    function debounce(func, delay) {
        let timeoutId;
        return function () {
            const context = this;
            const args = arguments;
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(context, args), delay);
        };
    }

    function renderPagination(currentPage, totalPages) {
        var html = '<nav aria-label="Page navigation example"><ul class="pagination justify-content-end">';

        var startPage = currentPage - 2;
        var endPage = currentPage + 2;

        if (startPage < 1) {
            startPage = 1;
            endPage = 5;
        }

        if (endPage > totalPages) {
            endPage = totalPages;
            startPage = totalPages - 4;
        }

        if (startPage < 1) {
            startPage = 1;
        }

        html += '<li class="page-item ' + (currentPage == 1 ? 'disabled' : '') + '"><a class="page-link" href="#" data-page="' + (currentPage - 1) + '">Trước</a></li>';

        for (var i = startPage; i <= endPage; i++) {
            html += '<li class="page-item ' + (currentPage == i ? 'active' : '') + '"><a class="page-link" href="#" data-page="' + i + '">' + i + '</a></li>';
        }

        html += '<li class="page-item ' + (currentPage == totalPages ? 'disabled' : '') + '"><a class="page-link" href="#" data-page="' + (currentPage + 1) + '">Sau</a></li>';

        html += '</ul></nav>';
        $('#pagination').html(html);
    }

    function unixTimestampToDate(timestamp) {
        var date = new Date(timestamp * 1000);
        var day = date.getDate();
        var month = date.getMonth() + 1;
        var year = date.getFullYear();

        return (day < 10 ? '0' + day : day) + '/' + (month < 10 ? '0' + month : month) + '/' + year;
    }

</script>