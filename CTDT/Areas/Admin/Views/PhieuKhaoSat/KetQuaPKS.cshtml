@{
    ViewBag.Title = "Kết quả khảo sát - TDMU";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="main-content">
    <div class="page-header">
        <h2 class="header-title">DANH SÁCH PHIẾU KHẢO SÁT</h2>
        <div class="header-sub-title">
            <nav class="breadcrumb breadcrumb-dash">
                <a href="#" class="breadcrumb-item"><i class="anticon anticon-home m-r-5"></i>Home</a>
                <span class="breadcrumb-item active">Thống kê kết quả phiếu khảo sát</span>
            </nav>
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <h4>Thống kê kết quả phiếu khảo sát</h4>
            <div>
                <!-- Button trigger modal -->
                <button type="button" class="btn btn-success btn-tone m-r-5" data-toggle="modal" data-target="#exampleModal">
                    Xuất Excel
                </button>

                <!-- Modal -->
                <div class="modal fade" id="exampleModal">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">Xuất Kết Quả Phiếu Khảo Sát Ra Excel</h5>
                                <button type="button" class="close" data-dismiss="modal">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label">Theo CTĐT:</label>
                                    <div class="col-sm-9">
                                        <select id="selectCTDT" class="form-control">
                                            <option value="">Chọn CTĐT</option>
                                            @foreach (var ctdt in ViewBag.CTDTList)
                                            {
                                                <option value="@ctdt.Value">@ctdt.Text</option>
                                            }
                                        </select>

                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                                <button type="button" class="btn btn-primary" onclick="XuatExcel()">Xuất</button>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-secondary btn-tone m-r-5" onclick="window.location.href='/Admin/PhieuKhaoSat/Index'">Quay trở về</button>
            </div>
            <div class="m-t-25">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th scope="col">STT</th>
                                <th scope="col">ID</th>
                                <th scope="col">CTĐT</th>
                                <th scope="col">Email</th>
                                <th scope="col">Sinh Viên</th>
                                <th scope="col">MSSV</th>
                                <th scope="col">Thời gian thực hiện</th>
                                <th scope="col">Chức năng</th>
                            </tr>
                        </thead>
                        <tbody id="showdata">
                        </tbody>
                    </table>
                    <div id="registrationForm"></div>

                </div>
                <pre id="surveyData"></pre>

            </div>
        </div>

    </div>
</div>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
<script>
    // Gọi hàm để chạy chương trình
    $(document).ready(function () {
        LoadData();
    });
    // Xuất Excel
    function XuatExcel() {
        var selectedCTDT = $("#selectCTDT").val();
        if (selectedCTDT !== "") {
            $.ajax({
                url: '/Admin/PhieuKhaoSat/ExportExcelSurvey?id=' + @ViewBag.id + '&cttdt=' + selectedCTDT,
                type: 'GET',
                success: function (data) {
                    if (data.length > 0) {
                        let timerInterval;
                        Swal.fire({
                            title: "Đang xuất dữ liệu ra Excel!",
                            html: "Vui lòng đợi trong <b></b> giây.",
                            timer: 3000,
                            timerProgressBar: true,
                            didOpen: () => {
                                Swal.showLoading();
                                const timer = Swal.getPopup().querySelector("b");
                                timerInterval = setInterval(() => {
                                    timer.textContent = `${Swal.getTimerLeft()}`;
                                }, 100);
                            },
                            willClose: () => {
                                clearInterval(timerInterval);
                                exportToExcel(data);
                            }
                        }).then((result) => {
                            if (result.dismiss === Swal.DismissReason.timer) {
                                console.log("I was closed by the timer");
                            }
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Không có dữ liệu',
                            text: 'Không có dữ liệu cho CTĐT này.'
                        });
                    }
                },
                error: function () {
                    console.error('Failed to fetch survey data.');
                }
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Chưa chọn CTĐT',
                text: 'Vui lòng chọn CTĐT trước khi xuất dữ liệu.'
            });
        }
    };


    function exportToExcel(data) {
        var workbook = XLSX.utils.book_new();
        var worksheet = XLSX.utils.aoa_to_sheet([]);

        var excelData = [];
        var titleRow = ["Dấu thời gian", "MSSV", "Họ và tên", "Email", "Ngày sinh", "Thuộc lớp", "Thuộc CTĐT", "Số điện thoại"];

        if (data.length > 0 && data[0].pages && data[0].pages.length > 0) {
            data[0].pages.forEach(function (page) {
                page.elements.forEach(function (element) {
                    titleRow.push(element.title);
                });
            });
        }
        excelData.push(titleRow);

        data.forEach(function (survey) {
            var rowData = [
                unixTimestampToDate(survey.DauThoiGian) || "",
                survey.MSSV || "",
                survey.HoTen || "",
                survey.Email || "",
                survey.NgaySinh || "",
                survey.Lop || "",
                survey.CTDT || "",
                survey.SDT || ""
            ];

            survey.pages.forEach(function (page) {
                page.elements.forEach(function (element) {
                    if (element.type === "text") {
                        rowData.push(element.response ? element.response.text || "" : "");
                    } else if (element.type === "radiogroup") {
                        rowData.push(element.response ? element.response.text || "" : "");
                    } else {
                        rowData.push("");
                    }
                });
            });
            excelData.push(rowData);
        });

        excelData.forEach(function (row) {
            XLSX.utils.sheet_add_aoa(worksheet, [row], { origin: -1 });
        });

        XLSX.utils.book_append_sheet(workbook, worksheet, 'SurveyData');
        var now = new Date();
        var timestamp = now.getFullYear().toString() +
            ('0' + (now.getMonth() + 1)).slice(-2) +
            ('0' + now.getDate()).slice(-2) +
            ('0' + now.getHours()).slice(-2) +
            ('0' + now.getMinutes()).slice(-2) +
            ('0' + now.getSeconds()).slice(-2);

        var fileName = 'KetQuaKhaoSat_' + timestamp + '.xlsx';

        XLSX.writeFile(workbook, fileName);
        var excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });

        var blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

        var formData = new FormData();
        formData.append('file', blob, 'KetQuaKhaoSat.xlsx');

        $.ajax({
            url: '/Admin/PhieuKhaoSat/SaveExcelFile',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function (response) {
                console.log('File saved successfully.');
            },
            error: function (xhr, status, error) {
                console.error('Failed to save file:', error);
            }
        });
    }

    // End Xuất Excel

    // Load dữ liệu Data
    function LoadData() {
        $.ajax({
            url: '/Admin/PhieuKhaoSat/LoadKetQuaPKS?id=' + @ViewBag.id,
            type: 'GET',
            success: function (res) {
                var items = res.data;
                var html = "";

                if (items.length === 0) {
                    html += "<tr><td colspan='7' class='text-center'>Không có dữ liệu</td></tr>";
                } else {
                    for (let i = 0; i < items.length; i++) {
                        var formattedThoiGianThucHien = unixTimestampToDate(items[i].ThoiGianThucHien);
                        var index = i + 1;
                        html += "<tr>";
                        html += "<td>" + index + "</td>";
                        html += "<td>" + "#" + items[i].MaKQ + "</td>";
                        if (items[i].CTDT == null) {
                            html += "<td>Không có dữ liệu</td>";
                        }
                        else {
                            html += "<td>" + items[i].CTDT + "</td>";
                        }
                        if (items[i].Email == null) {
                            html += "<td>Không có dữ liệu</td>";
                        }
                        else {
                            html += "<td>" + items[i].Email + "</td>";
                        }
                        if (items[i].SinhVien == null) {
                            html += "<td>Không có dữ liệu</td>";
                        }
                        else {
                            html += "<td>" + items[i].SinhVien + "</td>";
                        }
                        if (items[i].MSSV == null) {
                            html += "<td>Không có dữ liệu</td>";
                        }
                        else {
                            html += "<td>" + items[i].MSSV + "</td>";
                        }
                        html += "<td>" + formattedThoiGianThucHien + "</td>";
                        html += "<td><button class='btn btn-icon btn-hover btn-sm btn-rounded pull-right btnEdit' onclick=\"window.location.href='/Admin/PhieuKhaoSat/AnswerPKS?id=" + items[i].MaAnswer +"'\"> <i class='fas fa-chalkboard-teacher'></i></button></td>";
                        html += "</tr>";
                    }
                }
                $('#showdata').html(html);
            },
            error: function () {
                var html = "<tr><td colspan='7' class='text-center'>Không thể tải dữ liệu</td></tr>";
                $('#showdata').html(html);
            }
        });
    };
    //End Load dữ liệu Data

    // Hàm chuyển đổi kiểu ngày unixTimestampToDate
    function unixTimestampToDate(unixTimestamp) {
        var date = new Date(unixTimestamp * 1000);

        var weekdays = ['Chủ Nhật', 'Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7'];

        var dayOfWeek = weekdays[date.getDay()];

        var month = ("0" + (date.getMonth() + 1)).slice(-2);
        var day = ("0" + date.getDate()).slice(-2);
        var year = date.getFullYear();
        var hours = ("0" + date.getHours()).slice(-2);
        var minutes = ("0" + date.getMinutes()).slice(-2);
        var seconds = ("0" + date.getSeconds()).slice(-2);
        var formattedDate = dayOfWeek + ', ' + day + "-" + month + "-" + year + " " + ', ' + hours + ":" + minutes + ":" + seconds;
        return formattedDate;
    }
    // End Hàm chuyển đổi kiểu ngày unixTimestampToDate
</script>