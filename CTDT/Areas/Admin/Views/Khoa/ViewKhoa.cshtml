
@{
    ViewBag.Title = "ViewKhoa";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="main-content">
    <div class="page-header">
        <h2 class="header-title">Quản Lý Danh Sách Khoa</h2>
        <div class="header-sub-title">
            <nav class="breadcrumb breadcrumb-dash">
                <a href="#" class="breadcrumb-item"><i class="anticon anticon-home m-r-5"></i>Home</a>
                <span class="breadcrumb-item active">Danh Sách Khoa</span>
            </nav>
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <h4>Quản Lý Danh Sách Khoa</h4>
            <div>
                <button class="btn btn-primary btn-tone m-r-5" data-toggle="modal" data-target="#bd-example-modal-lg">Thêm mới</button>
            </div>
            <!--Modal Thêm mới Khoa-->
            <div class="modal fade" id="bd-example-modal-lg">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title h4">Thêm mới Khoa</h5>
                            <button type="button" class="close" data-dismiss="modal">
                                <i class="anticon anticon-close"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="form-validation" method="post" action="/Khoa/Add">
                                <div class="form-group row">
                                    <label class="col-sm-2 col-form-label control-label">Tên Khoa *</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" name="ten_khoa" id="ten_khoa" placeholder="Nhập tên Khoa ... *">
                                    </div>
                                </div>
                            </form>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-danger btn-tone m-r-5" data-dismiss="modal">Thoát</button>
                                <button type="button" class="btn btn-success btn-tone m-r-5" id="btnSave">Lưu</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--End Modal Thêm mới Khoa-->
            <!-- Modal Sửa Khoa -->
            <div class="modal fade" id="ModalEditKhoa">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title h4">Sửa đổi Khoa</h5>
                            <button type="button" class="close" data-dismiss="modal">
                                <i class="anticon anticon-close"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="form-validation" method="post" action="/Khoa/Edit">
                                <div class="form-group row">
                                    <input type="hidden" name="Change_Id_Khoa" id="Change_Id_Khoa" />
                                    <input type="hidden" name="change_Ngay_Tao" id="change_Ngay_Tao" />
                                    <input type="hidden" name="change_Cap_Nhat" id="change_Ngay_Cap_Nhat" />
                                    <label class="col-sm-2 col-form-label control-label">Tên Khoa *</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" name="Change_ten_khoa" id="Change_ten_khoa">
                                    </div>
                                </div>
                            </form>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-danger btn-tone m-r-5" data-dismiss="modal">Thoát</button>
                                <button type="button" class="btn btn-success btn-tone m-r-5" id="btnSaveChange">Thay đổi</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--End Modal Sửa Khoa -->
            <div class="m-t-25">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th scope="col">STT</th>
                                <th scope="col">Mã Khoa</th>
                                <th scope="col">Tên Khoa</th>
                                <th scope="col">Ngày Cập Nhật</th>
                                <th scope="col">Ngày Tạo</th>
                                <th scope="col">Chức năng</th>
                            </tr>
                        </thead>
                        <tbody id="showdata">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            LoadData();
            $("#btnSave").click(function () {
                AddKhoa();
            });

            $(document).on("click", "#btnEdit", function () {
                var MaKhoa = $(this).closest("tr").find("td:eq(1)").text();
                GetByID(MaKhoa);
            });
            $(document).on("click", "#btnDelete", function () {
                var MaKhoa = $(this).closest("tr").find("td:eq(1)").text();
                var TenKhoa = $(this).closest("tr").find("td:eq(2)").text();
                if (confirm("Bạn có chắc muốn xóa khoa '" + TenKhoa + "'không?")) {
                    DelKhoa(MaKhoa);
                }
            });
            $(document).on("click", "#btnSaveChange", function () {
                EditKhoa();
            });
        });

        function LoadData() {
            $.ajax({
                url: '/Khoa/GetDataKhoa',
                type: 'GET',
                success: function (res) {
                    var items = res.data;
                    var html = "";
                    
                    if (items.length === 0) {
                        html += "<tr><td colspan='9' class='text-center'>Không có dữ liệu</td></tr>";
                    } else {
                        for (let i = 0; i < items.length; i++) {
                            var formattedDate1 = unixTimestampToDate(items[i].NgayCapNhat);
                            var formattedDate2 = unixTimestampToDate(items[i].NgayTao);
                            var index = i + 1;
                            html += "<tr>";
                            html += "<td>" + index + "</td>"
                            html += "<td>" +"#"+ items[i].MaKhoa + "</td>";
                            html += "<td>" + items[i].TenKhoa + "</td>";
                            html += "<td>" + formattedDate1 + "</td>";
                            html += "<td>" + formattedDate2 + "</td>";
                            html += "<td><button class='btn btn-icon btn-hover btn-sm btn-rounded pull-right ' id='btnEdit' data-toggle='modal' data-target='#ModalEditKhoa'> <i class='anticon anticon-edit'></i></button><button class='btn btn-icon btn-hover btn-sm btn-rounded pull-right' id='btnDelete' > <i class='anticon anticon-delete'></i></button> </td> ";
                            html += "</tr>";
                        }
                    }
                    $('#showdata').html(html);
                }
            });
        };

        function AddKhoa() {
            var ten_khoa = $("#ten_khoa").val();
            $.ajax({
                url: '/Khoa/Add',
                type: 'POST',
                dataType: 'JSON',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({
                    ten_khoa: ten_khoa
                }),
                success: function (response) {
                    alert(response.status);
                    LoadData();
                },
                error: function (response) {
                    alert(response.status)
                },
            });
        };

        function GetByID(id) {
            $.ajax({
                url: '/Khoa/GetByID',
                type: 'GET',
                data: { id: id },
                success: function (res) {
                    $('#Change_ten_khoa').val(res.data.ten_khoa);
                    $('#Change_Id_Khoa').val(res.data.id_khoa);
                    $('#change_Ngay_Tao').val(res.data.ngaytao);
                    $('#change_Ngay_Cap_Nhat').val(res.data.ngaycapnhat);
                }
            });
        }

        function EditKhoa(){
            var TenKhoa = $('#Change_ten_khoa').val();
            var MaKhoa = $('#Change_Id_Khoa').val();
            var NgayTao = $('#change_Ngay_Tao').val();
            var NgayCapNhat = $('#change_Ngay_Cap_Nhat').val();
            var khoa = {
                ten_khoa: TenKhoa,
                id_khoa: MaKhoa,
                ngaycapnhat: NgayCapNhat,
                ngaytao: NgayTao,
            };

            $.ajax({
                type: 'POST',
                url: '/Khoa/Edit',
                dataType: 'JSON',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(khoa),
                success: function (response) {
                    alert(response.status);
                    LoadData();
                }

            });
        };

        function DelKhoa(id) {
            $.ajax({
                type: 'POST',
                url: '/Khoa/Delete',
                data: { id : id },
                success: function (response) {
                    alert(response.status);
                    LoadData();
                },
                error: function (response) {
                    alert(response.status)
                },
            });
        };

        function unixTimestampToDate(unixTimestamp) {
            // Multiply by 1000 because JavaScript works in milliseconds instead of seconds
            var date = new Date(unixTimestamp * 1000);

            // Define an array of weekday names
            var weekdays = ['Chủ Nhật', 'Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7'];

            // Get the day of the week (0 = Sunday, 1 = Monday, ..., 6 = Saturday)
            var dayOfWeek = weekdays[date.getDay()];

            // Months are zero-based, so we add 1 to the month
            var month = ("0" + (date.getMonth() + 1)).slice(-2);
            var day = ("0" + date.getDate()).slice(-2);
            var year = date.getFullYear();
            var hours = ("0" + date.getHours()).slice(-2);
            var minutes = ("0" + date.getMinutes()).slice(-2);
            var seconds = ("0" + date.getSeconds()).slice(-2);

            // Display the formatted date with the day of the week
            var formattedDate = dayOfWeek + ', ' + day + "-" + month + "-" + year + " " +', '+ hours + ":" + minutes + ":" + seconds;
            return formattedDate;
        }

    </script>



