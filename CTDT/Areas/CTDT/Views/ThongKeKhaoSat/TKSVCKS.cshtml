@{
    ViewBag.Title = "Thống kê đối tượng thực hiện khảo sát - TDMU";
    Layout = "~/Areas/CTDT/Views/Shared/_CTDTLayout.cshtml";
}
<div class="main-content">
    <div class="page-header">
        <h2 class="header-title">Thống kê đối tượng thực hiện khảo sát</h2>
        <div class="header-sub-title">
            <nav class="breadcrumb breadcrumb-dash">
                <a href="#" class="breadcrumb-item"><i class="anticon anticon-home m-r-5"></i>Home</a>
                <span class="breadcrumb-item active">Danh sách đối tượng thực hiện khảo sát</span>
            </nav>
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <h4>Danh sách đối tượng thực hiện khảo sát</h4>
            <div class="col-sm-10" style="margin-top: 10px;">
                <select id="MaPKS" class="form-control">
                    <option value="">Tất cả</option>
                    @foreach (var item in ViewBag.PKSList)
                    {
                        <option value="@item.Value">@item.Text</option>
                    }
                </select>
            </div>
            <div class="col-sm-10" style="margin-top: 10px;">
                <select id="SurveyStatus" class="form-control">
                    <option value="0">Chưa khảo sát</option>
                    <option value="1">Đã khảo sát</option>
                </select>
            </div>
            <div class="col-sm-10" style="margin-top: 10px;">
                <button type="button" class="btn btn-info btn-tone m-r-5" id="FilterSV">Tìm kiếm</button>
                <button type="button" class="btn btn-success btn-tone m-r-5" id="ExportExcel">Xuất Excel</button>
            </div>
            <div id="data-table-section" class="m-t-25" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th scope="col">STT</th>
                                <th scope="col">Mã sinh viên</th>
                                <th scope="col">Họ và tên</th>
                                <th scope="col">Ngày sinh</th>
                                <th scope="col">Số điện thoại</th>
                                <th scope="col">CTĐT</th>
                                <th scope="col">Lớp</th>
                            </tr>
                        </thead>
                        <tbody id="showdata">
                            <!-- Data will be appended here by the script -->
                        </tbody>
                    </table>
                </div>
                <div id="pagination" class="m-t-15 pagination-right">
                    <!-- Pagination buttons will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    var currentPage = 1;
    var totalPages = 0;

    $(document).ready(function () {
        $("#FilterSV").click(function () {
            var selectPks = $("#MaPKS").val();
            var surveyStatus = $("#SurveyStatus").val();
            LoadData(1, selectPks, surveyStatus);
        });

        $("#ExportExcel").click(function () {
            Swal.fire({
                title: "Đang xuất dữ liệu...",
                html: "Vui lòng chờ trong <b></b> giây.",
                timer: 3000,
                timerProgressBar: true,
                didOpen: () => {
                    Swal.showLoading();
                    const timer = Swal.getHtmlContainer().querySelector("b");
                    timerInterval = setInterval(() => {
                        timer.textContent = `${Swal.getTimerLeft()}`;
                    }, 100);
                },
                willClose: () => {
                    clearInterval(timerInterval);
                }
            }).then((result) => {
                if (result.dismiss === Swal.DismissReason.timer) {
                    var selectCtdt = $("#MaCTDT").val();
                    var selectPks = $("#MaPKS").val();
                    var surveyStatus = $("#SurveyStatus").val();
                    window.location = '/CTDT/ThongKeKhaoSat/ExportToExcel?survey=' + selectPks + '&completed=' + (surveyStatus == "1");
                }
            });
        });


        $(document).on("click", ".page-link", function () {
            var page = $(this).data("page");
            if (page > 0 && page <= totalPages) {
                currentPage = page;
                var selectCtdt = $("#MaCTDT").val();
                var selectPks = $("#MaPKS").val();
                var surveyStatus = $("#SurveyStatus").val();
                LoadData(currentPage, selectCtdt, selectPks, surveyStatus);
            }
        });
    });

    function LoadData(pageNumber, survey, completed) {
        $.ajax({
            url: '/CTDT/ThongKeKhaoSat/LoadSVChuaKhaoSat',
            type: 'GET',
            data: { pageNumber: pageNumber, pageSize: 10,  survey: survey, completed: completed == "1" },
            success: function (res) {
                var items = res.data;
                totalPages = res.totalPages;
                var html = "";

                if (items.length === 0) {
                    html += "<tr><td colspan='7' class='text-center'>Không có dữ liệu</td></tr>";
                } else {
                    for (let i = 0; i < items.length; i++) {
                        var index = (pageNumber - 1) * 10 + i + 1;
                        html += "<tr>";
                        html += "<td>" + index + "</td>";
                        html += "<td>" + items[i].MSSV + "</td>";
                        html += "<td>" + items[i].Hoten + "</td>";
                        html += "<td>" + items[i].NgaySinh + "</td>";
                        html += "<td>" + items[i].SDT + "</td>";
                        html += "<td>" + items[i].CTDT + "</td>";
                        html += "<td>" + items[i].Lop + "</td>";
                        html += "</tr>";
                    }
                }
                $('#showdata').html(html);
                $('#data-table-section').show();
                renderPagination(pageNumber, totalPages);
            },
            error: function () {
                var html = "<tr><td colspan='7' class='text-center'>Không thể tải dữ liệu</td></tr>";
                $('#showdata').html(html);
                $('#data-table-section').show();
            }
        });
    }

    function renderPagination(currentPage, totalPages) {
        var html = '<nav aria-label="Page navigation example"><ul class="pagination justify-content-end">';

        var startPage = currentPage - 2;
        var endPage = currentPage + 2;

        if (startPage < 1) {
            startPage = 1;
            endPage = 5;
        }

        if (endPage > totalPages) {
            endPage = totalPages;
            startPage = totalPages - 4;
        }

        if (startPage < 1) {
            startPage = 1;
        }

        html += '<li class="page-item ' + (currentPage == 1 ? 'disabled' : '') + '"><a class="page-link" href="#" data-page="' + (currentPage - 1) + '">Trước</a></li>';

        for (var i = startPage; i <= endPage; i++) {
            html += '<li class="page-item ' + (currentPage == i ? 'active' : '') + '"><a class="page-link" href="#" data-page="' + i + '">' + i + '</a></li>';
        }

        html += '<li class="page-item ' + (currentPage == totalPages ? 'disabled' : '') + '"><a class="page-link" href="#" data-page="' + (currentPage + 1) + '">Tiếp</a></li>';
        html += '</ul></nav>';

        $('#pagination').html(html);
    }
</script>
